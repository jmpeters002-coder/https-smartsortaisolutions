{% extends 'base.html' %}

{% block content %}
<section style="max-width:720px;margin:80px auto;padding:30px;border-radius:12px;background:rgba(2,6,23,0.6);border:2px solid rgba(14,165,233,0.2);text-align:center;color:#fff;">
    <h2 style="color:#0ea5e9;">Please wait — confirming payment</h2>
    <p id="status-msg" style="font-size:16px;opacity:0.9;margin-top:10px;">Wait while we confirm payment...</p>
    <div style="margin-top:20px;">
        <div class="loader" style="width:48px;height:48px;border-radius:50%;border:5px solid rgba(255,255,255,0.1);border-top-color:#0ea5e9;margin:0 auto;animation:spin 1s linear infinite"></div>
    </div>
    <p style="margin-top:18px;font-size:13px;opacity:0.8;">If confirmation takes longer than 30 seconds, contact support.</p>
</section>

<style>
@keyframes spin { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
</style>
{% endblock %}

{% block scripts %}
<script>
(function(){
    const ref = '{{ reference }}';
    const statusEl = document.getElementById('status-msg');
    let pollInterval = 3000; // 3s
    let elapsed = 0;

    async function checkStatus(){
        try{
            const res = await fetch('/api/order-status/' + encodeURIComponent(ref));
            if(!res.ok){
                // keep polling on temporary errors
                return;
            }
            const data = await res.json();
            if(data.status === 'paid'){
                statusEl.textContent = 'Payment successful — redirecting to service granted...';
                // small delay so user sees success message
                setTimeout(()=>{
                    window.location = '/access/' + encodeURIComponent(ref);
                },1200);
            } else if(data.status === 'failed'){
                statusEl.textContent = 'Payment failed. Please contact support.';
            } else {
                statusEl.textContent = 'Wait while we confirm payment...';
            }
        }catch(e){
            console.warn('status check failed', e);
        }
    }

    // Poll until paid or timeout (2 minutes)
    const timer = setInterval(()=>{
        elapsed += pollInterval;
        if(elapsed > 120000){
            clearInterval(timer);
            statusEl.textContent = 'Taking longer than expected. Please contact support.';
            return;
        }
        checkStatus();
    }, pollInterval);

    // initial check immediately
    checkStatus();
})();
</script>
{% endblock %}