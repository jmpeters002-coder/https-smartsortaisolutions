{% extends "base.html" %}

{% block content %}

<section class="admin-header">
    <h1>üîê Admin Dashboard</h1>
    <p>View orders, monitor revenue, and manage fulfillment</p>
</section>

<section class="admin-content">
    <div class="container">
        
        <!-- STATS CARDS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total_orders_val">{{ total_orders }}</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card paid">
                <div class="stat-value" id="paid_orders_val">{{ paid_orders }}</div>
                <div class="stat-label">Paid Orders</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-value" id="pending_orders_val">{{ pending_orders }}</div>
                <div class="stat-label">Pending Orders</div>
            </div>
            <div class="stat-card revenue">
                <div class="stat-value" id="total_revenue_val">${{ total_revenue | round(2) }}</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="filters-section">
            <h3>Filter Orders</h3>
            <form method="get" class="filter-form">
                <select name="status" class="filter-select">
                    <option value="">All Status</option>
                    <option value="pending" {% if request.args.get('status') == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="paid" {% if request.args.get('status') == 'paid' %}selected{% endif %}>Paid</option>
                    <option value="failed" {% if request.args.get('status') == 'failed' %}selected{% endif %}>Failed</option>
                </select>
                <input type="email" name="email" placeholder="Filter by email" value="{{ request.args.get('email', '') }}" class="filter-input">
                <button type="submit" class="filter-btn">üîç Search</button>
            </form>
        </div>

        <!-- ORDERS TABLE -->
        <div class="orders-section">
            <h3>Orders</h3>
            <div class="table-wrapper">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer Email</th>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Payment Ref</th>
                            <th>Created</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="orders-tbody">
                        {% for order in orders %}
                        <tr class="order-row status-{{ order.status }}">
                            <td>#{{ order.id }}</td>
                            <td>{{ order.customer_email }}</td>
                            <td>{{ order.product.title }}</td>
                            <td>${{ order.product.price }}</td>
                            <td>
                                <span class="status-badge status-{{ order.status }}">
                                    {{ order.status | upper }}
                                </span>
                            </td>
                            <td>{{ order.payment_reference[:20] if order.payment_reference else '‚Äî' }}</td>
                            <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <form method="post" action="/admin/override/{{ order.id }}" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="action-btn override-btn" 
                                        {% if order.status == 'paid' %}disabled{% endif %}>
                                        ‚úì Fulfill
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" style="text-align:center; padding:30px;">No orders found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- REVENUE BREAKDOWN -->
        <div class="revenue-section">
            <h3>Revenue Breakdown</h3>
            <div class="revenue-grid">
                <div class="revenue-card">
                    <div class="revenue-type">By Product Type</div>
                    {% for ptype, revenue in revenue_by_type.items() %}
                    <div class="revenue-item">
                        <span>{{ ptype | title }}</span>
                        <span class="revenue-amount">${{ revenue | round(2) }}</span>
                    </div>
                    {% endfor %}
                </div>
                <div class="revenue-card">
                    <div class="revenue-type">By Order Status</div>
                    {% for status, revenue in revenue_by_status.items() %}
                    <div class="revenue-item status-{{ status }}">
                        <span>{{ status | upper }}</span>
                        <span class="revenue-amount">${{ revenue | round(2) }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- ACCESS GRANTS -->
        <div class="access-section">
            <h3>User Access Grants</h3>
            <div class="table-wrapper">
                <table class="access-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Product</th>
                            <th>Type</th>
                            <th>Granted At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for access in recent_access %}
                        <tr>
                            <td>{{ access.customer_email }}</td>
                            <td>{{ access.product.title }}</td>
                            <td><span class="badge badge-{{ access.access_type }}">{{ access.access_type | upper }}</span></td>
                            <td>{{ access.granted_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align:center; padding:20px;">No access grants yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</section>

{% endblock %}

{% block scripts %}
<script>
// CSRF token for JS-generated forms
const CSRF_TOKEN = "{{ csrf_token() }}";
// Poll dashboard-data every 5 seconds and update table/stats
const refreshInterval = 5000;

async function fetchDashboardData() {
    try {
        const res = await fetch('/admin/dashboard-data');
        if (!res.ok) return;
        const data = await res.json();

        // Update stats
        document.getElementById('total_orders_val').textContent = data.total_orders;
        document.getElementById('paid_orders_val').textContent = data.paid_orders;
        document.getElementById('pending_orders_val').textContent = data.pending_orders;
        document.getElementById('total_revenue_val').textContent = '$' + (Math.round((data.total_revenue + Number.EPSILON) * 100) / 100).toFixed(2);

        // Update orders table
        const tbody = document.getElementById('orders-tbody');
        if (!tbody) return;
        const orders = data.orders || [];
        if (orders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px;">No orders found</td></tr>';
            return;
        }

        tbody.innerHTML = orders.map(o => {
            const paymentRef = o.payment_reference ? o.payment_reference.substring(0,20) : '‚Äî';
            const created = new Date(o.created_at).toLocaleString();
            const disableBtn = o.status === 'paid' ? 'disabled' : '';
            return `
                <tr class="order-row status-${o.status}">
                    <td>#${o.id}</td>
                    <td>${o.customer_email}</td>
                    <td>${o.product_title || ''}</td>
                    <td>$${o.price}</td>
                    <td><span class="status-badge status-${o.status}">${o.status.toUpperCase()}</span></td>
                    <td>${paymentRef}</td>
                    <td>${created}</td>
                    <td>
                        <form method="post" action="/admin/override/${o.id}" style="display:inline;">
                            <input type="hidden" name="csrf_token" value="${CSRF_TOKEN}">
                            <button type="submit" class="action-btn override-btn" ${disableBtn}>‚úì Fulfill</button>
                        </form>
                    </td>
                </tr>`;
        }).join('');

    } catch (e) {
        console.warn('Dashboard refresh failed', e);
    }
}

setInterval(fetchDashboardData, refreshInterval);
// Initial load
fetchDashboardData();
</script>
{% endblock %}
